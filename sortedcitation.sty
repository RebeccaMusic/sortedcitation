%% LaTeX2e file `sortedcitation.sty'
%% generated by the `filecontents' environment
%% from source `文章_sortedcitation20250518' on 2025/05/18.
%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{sortedcitation}

\usepackage{tikz}%\foreach
\usepackage{graphicx}%\loop\repeat
\usepackage{ifthen}%\ifthenelse
\newcounter{citenum}%cite的bib序號，如果cite一個新的ibitem，就增加1。如果定義\global\newcount\citenum，這個參數不是全局變量
\newcounter{bibnum}%bibitem的序號，bibliography item已被cited，放在cite set中，citeentries\citenum；未被cited，放在bib set中，用bibentries\bibnum表示
\setcounter{citenum}{0}
\setcounter{bibnum}{0}
\newcounter{tmp}%used in loop
\global\newif\ifcited%whether a bibitem is cited namely in cite set
\newcounter{repeatedly}%wheter a cite item is a repeated one, so the cite set remains the same
\setcounter{repeatedly}{0}
\newcounter{inciteset}%whether a bibitem already in the cite set
\newcommand\scite[1]{
 \ifnum \value{citenum}>0{%
 \setcounter{tmp}{0}
 \loop
  \stepcounter{tmp}
  %check whether the label in cite set
  \ifthenelse{\equal{\csname citeentries\thetmp.labelname\endcsname}{#1}}{
  [\hyperlink{refpage}{\csname citeentries\thetmp.seqno\endcsname}]%
  \stepcounter{repeatedly}
  \setcounter{tmp}{\value{citenum}}}{}
 \ifnum \value{tmp}<\value{citenum} \repeat
 }\fi
 \ifnum \value{repeatedly}>0{
 \setcounter{repeatedly}{0}}%reset the icon}
 \else{%cite a new ref, put it into the cite set
 \stepcounter{citenum}%
 \expandafter\gdef\csname citeentries\thecitenum.labelname\endcsname{#1}% \\
 \expandafter\xdef\csname citeentries\thecitenum.seqno\endcsname{\thecitenum}%
 [\hyperlink{refpage}{\csname citeentries\thecitenum.seqno\endcsname}]%seq number
 }\fi 
}


\newcommand{\sbibitem}[2]{%#1 bib label name, #2 the reference
 \setcounter{inciteset}{0}%reset inciteset icon
 \ifnum \value{citenum}>0{% Check whether the bibitem in the cite set, if yes, assign the .ref attribute
 \setcounter{tmp}{0}
 \loop
  \stepcounter{tmp}
  \ifthenelse{\equal{\csname citeentries\thetmp.labelname\endcsname}{#1}}{
  \expandafter\gdef\csname citeentries\thetmp.ref\endcsname{#2}%
  \stepcounter{inciteset}
  \setcounter{tmp}{\value{citenum}}}{}  
 \ifnum \value{tmp}<\value{citenum} \repeat
 }\fi
 
 \ifnum \value{inciteset}=0  {%if the bibitem is not in the cite set, put it in bib set
 \stepcounter{bibnum}
 \expandafter\gdef\csname bibentries\thebibnum.labelname\endcsname{#1}
 \expandafter\gdef\csname bibentries\thebibnum.seqno\endcsname{#1}
 %Here we set the seqno to the labelname indicating it is not cited.
 \expandafter\gdef\csname bibentries\thebibnum.ref\endcsname{#2}
}\fi}

\newenvironment{sbibliography}{%begin code
\section *{\hypertarget{refpage}{ \refname }}
\parindent=0em}
{%end code
\ifnum\value{citenum}>0{
\setcounter{tmp}{0}%print cite set
 \loop
  \stepcounter{tmp}
  [\csname citeentries\thetmp.seqno\endcsname]\,\csname citeentries\thetmp.ref\endcsname \\
 \ifnum \value{tmp}<\value{citenum} \repeat
 }\fi
\ifnum\value{bibnum}>0{%print bib set
\setcounter{tmp}{0}
 \loop
  \stepcounter{tmp}
  [\csname bibentries\thetmp.seqno\endcsname]\,\csname bibentries\thetmp.ref\endcsname \\
 \ifnum \value{tmp}<\value{bibnum} \repeat
 }\fi
}
