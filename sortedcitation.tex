%
%   SortedCitation package is free software; you can redistribute it and/or modify
%   it under the terms of the GNU General Public License as published by
%   the Free Software Foundation; either version 2, or (at your option)
%   any later version.
%
%   SortedCitation package is distributed in the hope that it will be useful,
%   but WITHOUT ANY WARRANTY; without even the implied warranty of
%   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%   GNU General Public License for more details.
%
%   You should have received a copy of the GNU General Public License
%   along with this package; see the file COPYING.  If not, write to
%   the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
%   Boston, MA 02111-1307, USA.
%
%	Author: Rebecca rebeccacoding@163.com
%			https://github.com/RebeccaMusic
%

\begin{filecontents}{sortedcitation.sty}
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{sortedcitation}

\usepackage{tikz}%\foreach

\usepackage{graphicx}%\loop\repeat
\usepackage{ifthen}%\ifthenelse
% Algorithm
% Build two sets：1)a cite set named citeentries，the cardinality is citenum which is counter datatype，2)bib set named bibentries, whose cardinality is bibnum, symmetrically. The item in these two sets has the same data structure: an object with the attributes labelname, seqno, ref, all string data type. 

% The key is how to realize a set. Dr. FeuersÃ¤nger introduces all the tools in Notes On Programming in TEX Revision 1.18.1, https://pgfplots.sourceforge.net/TeX-programming-notes.pdf: 
%csname to define a macro name, it could be  citeentries1.labelname, citeentries1.seqno, citeentries1.ref, citeentries2.label,...
%
%To assign such a macro a string value, use \expandafter\gdef, because \expandafter\def works locally, but we need the set variables to be global.
%
%Whenever a citation happens, first check whether it is a repeated one or new. If it is new, \stepcounter{citenum}. 
%
%Whenever a bibitem shows, first using labelname to check whether it is in the cite set. If it is in the cite set, assign the ref content to the attribute .ref. If it is not in the cite set, put it in the bib set which stores bib items not cited, and assign labelname to .seqno attribute so one can see it is not cited.

%Besides, https://latex-tutorial.com/advanced-latex-cross-references/ tells me \hyperlink{key}{link caption} \hypertarget{key}{target caption} for cross reference from citation in place to bibliography page.

\newcounter{citenum}%the cardinalty of the growing cite set, once a biblabel is cited, \stepcounter{citenum}. If \global\newcount\citenum, it is not a global variable
\newcounter{bibnum}%the cardinalty of the growing cite set. If the biblabel is cited, aka it is in cite set, assign ref content to the attribute .ref. If it is not cited, put it in bib set, denoted as bibentries\bibnum.
\setcounter{citenum}{0}
\setcounter{bibnum}{0}
\newcounter{tmp}%used in loop
\global\newif\ifcited%whether a bibitem is cited namely in cite set
\newcounter{repeatedly}%wheter a cite item is a repeated one, so the cite set remains the same
\setcounter{repeatedly}{0}
\newcounter{inciteset}%whether a bibitem already in the cite set
\newcommand\scite[1]{
	\ifnum \value{citenum}>0{%
	\setcounter{tmp}{0}
	\loop
		\stepcounter{tmp}
		%check whether the label in cite set
		\ifthenelse{\equal{\csname citeentries\thetmp.labelname\endcsname}{#1}}{
		[\hyperlink{refpage}{\csname citeentries\thetmp.seqno\endcsname}]%
		\stepcounter{repeatedly}
		\setcounter{tmp}{\value{citenum}}}{}
	\ifnum \value{tmp}<\value{citenum} \repeat
	}\fi
	\ifnum \value{repeatedly}>0{
	\setcounter{repeatedly}{0}}%reset the icon}
	\else{%cite a new ref, put it into the cite set
	\stepcounter{citenum}%
	\expandafter\gdef\csname citeentries\thecitenum.labelname\endcsname{#1}% \\
	\expandafter\xdef\csname citeentries\thecitenum.seqno\endcsname{\thecitenum}%
	[\hyperlink{refpage}{\csname citeentries\thecitenum.seqno\endcsname}]%seq number
	}\fi	
}


\newcommand{\sbibitem}[2]{%#1 bib label name, #2 the reference
	\setcounter{inciteset}{0}%reset inciteset icon
	\ifnum \value{citenum}>0{% Check whether the bibitem in the cite set, if yes, assign the .ref attribute
	\setcounter{tmp}{0}
	\loop
		\stepcounter{tmp}
		\ifthenelse{\equal{\csname citeentries\thetmp.labelname\endcsname}{#1}}{
		\expandafter\gdef\csname citeentries\thetmp.ref\endcsname{#2}%
		\stepcounter{inciteset}
		\setcounter{tmp}{\value{citenum}}}{}		
	\ifnum \value{tmp}<\value{citenum} \repeat
	}\fi
	
	\ifnum \value{inciteset}=0  {%if the bibitem is not in the cite set, put it in bib set
	\stepcounter{bibnum}
	\expandafter\gdef\csname bibentries\thebibnum.labelname\endcsname{#1}
	\expandafter\gdef\csname bibentries\thebibnum.seqno\endcsname{#1}
	%Here we set the seqno to the labelname indicating it is not cited.
	\expandafter\gdef\csname bibentries\thebibnum.ref\endcsname{#2}
}\fi}

\newenvironment{sbibliography}{%begin code
\section *{\hypertarget{refpage}{ \refname }}
\parindent=0em}
{%end code
\ifnum\value{citenum}>0{
\setcounter{tmp}{0}%print cite set
	\loop
		\stepcounter{tmp}
		[\csname citeentries\thetmp.seqno\endcsname]\,\csname citeentries\thetmp.ref\endcsname \\
	\ifnum \value{tmp}<\value{citenum} \repeat
	}\fi
\ifnum\value{bibnum}>0{%print bib set
\setcounter{tmp}{0}
	\loop
		\stepcounter{tmp}
		[\csname bibentries\thetmp.seqno\endcsname]\,\csname bibentries\thetmp.ref\endcsname \\
	\ifnum \value{tmp}<\value{bibnum} \repeat
	}\fi
}
\end{filecontents}

\documentclass[a4paper]{article}
\usepackage{hyperref}
\usepackage{tikz}
\usetikzlibrary{external}%used in an example from Wichtige LATEX Befehle https://pgfplots.sourceforge.net/MeineKurzReferenz.pdf
\usepackage{fancyvrb-ex}
\usepackage{sortedcitation}
\title{An Example for Package sortedcitation}
\begin{document}
\maketitle
This is a note for ``\href{https://pgfplots.sourceforge.net/TeX-programming-notes.pdf}{Notes On Programming in TEX}'', the author Dr. Christian Feuers\~A\textcurrency nger.\scite{thearticle}

\section*{1 Introduction}
This document is intended to provide a direct start with TEX programming (not necessarily TEX typesetting).
The addressed audience consists of people interested in package or library writing.
At the time of this writing, this document is far from complete. Nevertheless, it might be a good starting
point for interested readers. Consult the literature given below for more details.

\section*{2 Programming in TEX}
\subsection*{2.1 Variables in Registers}
TEX provides several different variables and associated registers which can be manipulated freely.

\textbackslash  count〈num〉

There are 256 Integer registers which provide 32 Bit Integer arithmetics. The registers can be used for
example with \textbackslash  count0=42 or \textbackslash  count7=\textbackslash  macro where \textbackslash  macro expands to a number.

The value of a register can be typeset using \textbackslash  the〈register 〉

\begin{Example}
\count0=42
The value is now ‘\the\count0’.
\def\macro{-123456}
\count0=\macro
The value is now ‘\the\count0’.
\end{Example}

The ‘=’ sign is optional and can be omitted. One thing is common among the registers: an assignment
of the form \textbackslash count0=〈· · · 〉 expands everything which follows until the expansion doesn’t need more
numbers – even more than one following macro.

\begin{Example}
\def\firstmacro{123}
\def\secondmacro{456}
\def\thirdmacro{789}
\count0=\firstmacro\secondmacro\thirdmacro
The value is now ‘\the\count0’.
\end{Example}
The precise rules can be found in \scite{knuth}, but it should be kept in mind that care needs to be taken here.
More than once, my code failed to produce the expected result because TEX kept expanding macros
and the registers got unexpected results. Here is the correct method:

\begin{Example}
1. \count0=42 % a white space after the number aborts the reading process. It is discarded.
The value is now ‘\the\count0’.
2. The following code will absorb the ‘3’ of ’3.’:
\def\macro{1234}
\count0=\macro % a white space after a macro will be absorbed by TeX, so this is wrong.
3. The value is now ‘\the\count0’.
4. Use \verb"\relax" after an assignment to end scanning:
\count0=\macro\relax
The value is now ‘\the\count0’.
\end{Example}
The command \textbackslash relax tells TEX to “relax”: it stops scanning for tokens, but \textbackslash relax doesn’t expand to
anything.
\section*{An example from Wichtige LATEX Befehle\scite{german}}
\begin{Example}
\tikzset{
every overlay node/.style={
draw=black,fill=white,rounded corners,anchor=north west,
},
}
\def\tikzoverlay{%
 \tikzexternaldisable
 \tikz[baseline,overlay]\node[every overlay node,/utils/exec=\
tikzexternalenable]}

\tikzoverlay[text width=6cm] at (9.3cm,5cm) {
\begin{itemize}
\item \emph{Derive subclass} from \texttt{GetOptWrapper}
\item one \emph{variable definition} per option
\item \emph{Default Values}
\end{itemize}
};
\end{Example}

\begin{sbibliography}
\sbibitem{german}{N. Schwartz. Einf\"uhrung in TEX (german!). Addison Wesley, 1991,  \url{http://www.ruhr-uni-bochum.de/www-rz/schwanbs/TeX/}}
\sbibitem{thearticle}{Dr. Christian Feuers\~A\textcurrency nger, ``Notes On Programming in TEX Revision 1.18.1'' , 2021/05/15, \url{https://pgfplots.sourceforge.net/TeX-programming-notes.pdf}}
\sbibitem{knuth}{D. Knuth, ``Computers \& Typesetting'', Addison Wesley, 2000}
\end{sbibliography}

\end{document}
